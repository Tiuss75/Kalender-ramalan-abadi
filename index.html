<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Kalender Jawa lengkap dengan weton, primbon, dan filosofi Jawa.">
    <meta name="keywords" content="kalender jawa, weton, primbon, kalender abadi, tanggal jawa, imlek">
    <meta name="author" content="Tius">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#D30000">
    <link rel="manifest" href="manifest.json">
    
    <title>Kalender Abadi Jawa</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
<meta name="google-site-verification" content="rADhVWnVQtbHErE7NCZc_fmgwkGePxNzRk_a_oy3y1A" />

    <style>
        :root { 
            --primary: #D30000; 
            --bg: #f4f4f4; 
            --imlek: #cf1322; 
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --radius: 15px;
        }
        
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px;
            min-height: 100vh;
        }
        
        #mainApp { 
            max-width: 500px; 
            margin: auto; 
            background: white; 
            padding: 15px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
        }
        
        .header-section { 
            text-align: center; 
            margin-bottom: 20px; 
        }
        
        .search-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .search-group {
            flex: 1;
        }
        
        .search-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }
        
        .search-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: #fff;
        }
        
        .search-group input:focus {
            border-color: #D30000;
            outline: none;
            box-shadow: 0 0 0 3px rgba(211, 0, 0, 0.1);
        }
        
        #searchDateBtn {
            background: #D30000;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 46px;
            white-space: nowrap;
        }
        
        #searchDateBtn:hover {
            background: #b00000;
        }
        
        .calendar-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        
        .calendar-nav button { 
            background: var(--primary); 
            color: white;
            border: none; 
            padding: 8px 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
        }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 5px; 
            text-align: center; 
        }
        
        .header-day { 
            font-weight: bold; 
            font-size: 11px; 
            padding: 5px 0; 
            color: #666; 
            text-transform: uppercase; 
        }
        
        .sunday-red { 
            color: red !important; 
        }
        
        .calendar-day { 
            border: 1px solid #eee; 
            padding: 8px 2px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            min-height: 55px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        .calendar-day:hover { 
            border-color: var(--primary); 
            background: #fff5f5; 
        }
        
        .today-highlight { 
            background: #fff0f0; 
            border: 2px solid var(--primary); 
        }
        
        .selected-day { 
            background: #fff9c4 !important; 
            border: 2px solid #fbc02d !important; 
        }
        
        .date-num { 
            font-weight: bold; 
            font-size: 1.1rem; 
        }
        
        .pasaran-text { 
            font-size: 9px; 
            color: #555; 
            margin-top: 2px; 
        }
        
        #detail { 
            margin-top: 20px; 
            border-top: 2px solid #eee; 
            padding-top: 15px; 
            display: none; 
        }
        
        .searched-date {
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%) !important;
            border: 2px solid #F57C00 !important;
        }
        
        /* Ramalan Shio Styles */
        .shio-ramalan-card {
            background: linear-gradient(135deg, #a3b17d 0%, #8a9a5b 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .shio-category {
            background: linear-gradient(135deg, #8a9a5b 0%, #76844e 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            color: white;
        }

        .shio-category h4 {
            margin-top: 0;
            color: white;
            font-weight: 600;
        }
        
        /* Token Modal Styles */
        .token-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .token-modal-content {
            background: white;
            width: 90%;
            max-width: 350px;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .token-modal-content h2 {
            color: var(--primary);
            margin-top: 0;
        }
        
        .token-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            box-sizing: border-box;
        }
        
        .token-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-size: 16px;
        }
        
        .token-wa-btn {
            background: #25D366;
            color: white;
            text-decoration: none;
            display: block;
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Scroll to Top Button */
        #scrollTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D30000 0%, #9B0000 100%);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(211, 0, 0, 0.3);
            display: none;
            z-index: 999;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        #scrollTopBtn:hover {
            background: linear-gradient(135deg, #B00000 0%, #7A0000 100%);
            transform: scale(1.1);
            box-shadow: 0 6px 18px rgba(211, 0, 0, 0.4);
        }
        
        #scrollTopBtn:active {
            transform: scale(0.95);
        }
        
        /* Premium Badge */
        .premium-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        /* Firebase Status */
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .firebase-status.online {
            background: #4CAF50;
            color: white;
        }
        
        .firebase-status.offline {
            background: #F44336;
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            #mainApp {
                padding: 10px;
            }
            
            .calendar-day {
                min-height: 45px;
                padding: 5px 1px;
            }
            
            .date-num {
                font-size: 1rem;
            }
            
            .search-form {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-section {
                padding: 15px;
            }
            
            #scrollTopBtn {
                bottom: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .firebase-status {
                position: static;
                margin: 10px auto;
                display: inline-block;
            }
        }
    </style>
</head>
<body>

<!-- Firebase Status Indicator -->
<div id="firebaseStatus" class="firebase-status offline">
    üîå Firebase: Offline
</div>

<!-- Token Modal -->
<div id="tokenModal" class="token-modal">
    <div class="token-modal-content">
        <h2>üîë Akses Token</h2>
        <p style="font-size: 14px; color: #666;">Masukkan token untuk akses lengkap:</p>
        <input type="text" id="tokenInput" class="token-input" placeholder="Masukkan kode token...">
        <button class="token-btn" onclick="validateToken()">Aktifkan Token</button>
        
        <div style="margin: 15px 0; display: flex; gap: 10px;">
            <button onclick="checkTokenFromURL()" style="flex:1; padding:8px; background:#9C27B0; color:white; border:none; border-radius:5px; font-size:12px;">
                üîó Cek dari URL
            </button>
            <button onclick="testFirebaseConnection()" style="flex:1; padding:8px; background:#607D8B; color:white; border:none; border-radius:5px; font-size:12px;">
                üì° Test Koneksi
            </button>
        </div>
        
        <p style="margin: 15px 0 5px; font-size: 12px;">Belum punya token?</p>
        <a href="https://wa.me/6285117021168?text=Halo%20admin,%20saya%20ingin%20membeli%20token%20Kalender%20Jawa" 
           class="token-wa-btn" target="_blank">
           üí¨ Beli Token via WhatsApp
        </a>
        
        <button onclick="closeTokenModal()" style="
            background:none; 
            border:none; 
            color:#aaa; 
            margin-top:10px; 
            cursor:pointer;
            font-size: 14px;
        ">
            Nanti Saja
        </button>
    </div>
</div>

<div id="mainApp">
    <div class="header-section">
        <h1 style="margin:0; font-size: 22px; color: var(--primary);">üìÖ Kalender Abadi Jawa</h1>
        <p style="margin:5px 0; font-size: 13px; color: #888;">Jawa ‚Ä¢ Masehi ‚Ä¢ Imlek ‚Ä¢ Weton Lengkap</p>
        <p id="appStatus" style="margin:5px 0; font-size: 11px; color: #25D366;"></p>
        
        <!-- Premium Badge -->
        <div class="premium-badge" id="premiumBadge">
            <i class="fas fa-crown"></i> FREE
        </div>
        
        <!-- Token Access Button -->
        <button onclick="showTokenModal()" style="
            background: #FF9800;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
            font-weight: bold;
        ">
            üîë Token Premium
        </button>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <h3 style="color: #D30000; margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
            üîç Cari Tanggal Spesifik
        </h3>
        
        <div class="search-form">
            <div class="search-group">
                <label for="dateSearchInput">Pilih Tanggal:</label>
                <input type="date" id="dateSearchInput" name="dateSearchInput">
            </div>
            
            <button id="searchDateBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Cari
            </button>
        </div>
    </div>

    <!-- Calendar Navigation -->
    <div class="calendar-nav">
        <button id="prevMonth">‚óÄ </button>
        <h3 id="monthYearNav" style="margin: 0;">Januari 2026</h3>
        <button id="nextMonth"> ‚ñ∂</button>
    </div>
    
    <!-- Calendar Grid -->
    <div id="calendar" class="calendar-grid"></div>

    <!-- Detail Section -->
    <div id="detail"></div>
  
    <div style="margin-top: 20px; text-align: center; font-size: 11px; color: #888; border-top: 1px solid #eee; padding-top: 10px;">
        <p style="margin-bottom: 15px;">
            <a href="panduan.html" style="color: #28a745; text-decoration: none; font-weight: bold; border: 1px solid #28a745; padding: 4px 10px; border-radius: 12px;">
                üìñ Panduan Cari Hari Baik
            </a>
        </p>
    </div>
    
    <!-- Footer Info -->
    <div style="margin-top: 20px; text-align: center; font-size: 11px; color: #888; border-top: 1px solid #eee; padding-top: 10px;">
        <p>üì± <strong>Aplikasi Kalender Jawa</strong> - Versi Lengkap</p>
        <p>‚ö° <strong>Ramalan Shio Harian</strong> - Update Otomatis</p>
        <p>üîÑ <strong>by Tius</strong> - ¬© 2026</p>
        
      
            </a>
        </div>
        
        <!-- Firebase Info -->
        <div id="firebaseInfo" style="margin-top: 10px; font-size: 10px; color: #666;">
            Status: Loading...
        </div>
    </div>
</div>

<!-- Scroll to Top Button -->
<button id="scrollTopBtn" title="Kembali ke atas">
    <i class="fas fa-arrow-up"></i>
</button>

<!-- Load Scripts -->
<script src="main.js"></script>
<script src="ramalan-shio.js"></script>

<script>
// ==================== FIREBASE CONFIGURATION ====================
// üî• GANTI DENGAN KONFIGURASI FIREBASE ANDA (SAMA dengan admin.html)
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCir9IhWurIN8P2LiCfb445ss-bsurrFG4",
    authDomain: "kalender-ramalan.firebaseapp.com",
    databaseURL: "https://kalender-ramalan-default-rtdb.firebaseio.com",
    projectId: "kalender-ramalan",
    storageBucket: "kalender-ramalan.firebasestorage.app",
    messagingSenderId: "811026418437",
    appId: "1:811026418437:web:b0efdd1eb52fd4688bc56c"
};

// ==================== GLOBAL VARIABLES ====================
let firebaseApp = null;
let database = null;
let isFirebaseConnected = false;

// ==================== FIREBASE FUNCTIONS ====================
function initializeFirebase() {
    try {
        firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
        database = firebase.database();
        
        // Set up connection state listener
        const connectedRef = database.ref(".info/connected");
        connectedRef.on("value", function(snap) {
            isFirebaseConnected = snap.val() === true;
            updateConnectionStatus();
            
            if (isFirebaseConnected) {
                console.log("‚úÖ Firebase connected");
                // Sync token when connected
                syncTokenWithFirebase();
            } else {
                console.log("üîå Firebase disconnected");
            }
        });
        
        console.log("‚úÖ Firebase initialized successfully");
        updateFirebaseInfo("Firebase terhubung");
        
    } catch (error) {
        console.error("‚ùå Firebase initialization error:", error);
        updateFirebaseInfo(`Error: ${error.message}`);
    }
}

function updateConnectionStatus() {
    const badgeElement = document.getElementById('firebaseStatus');
    const infoElement = document.getElementById('firebaseInfo');
    
    if (isFirebaseConnected) {
        if (badgeElement) {
            badgeElement.className = "firebase-status online";
            badgeElement.innerHTML = "‚úÖ Firebase: Online";
        }
        if (infoElement) {
            infoElement.innerHTML = "‚úÖ Terhubung ke server token";
        }
    } else {
        if (badgeElement) {
            badgeElement.className = "firebase-status offline";
            badgeElement.innerHTML = "üîå Firebase: Offline";
        }
        if (infoElement) {
            infoElement.innerHTML = "‚ö†Ô∏è Mode offline - token lokal saja";
        }
    }
}

function updateFirebaseInfo(message) {
    const infoElement = document.getElementById('firebaseInfo');
    if (infoElement) {
        infoElement.innerHTML = message;
    }
}

async function testFirebaseConnection() {
    try {
        updateFirebaseInfo("üîÑ Testing connection...");
        
        // Test write
        const testRef = database.ref('testConnection');
        await testRef.set({
            timestamp: Date.now(),
            test: "connection_test"
        });
        
        // Test read
        const snapshot = await testRef.once('value');
        const data = snapshot.val();
        
        // Clean up
        await testRef.remove();
        
        updateFirebaseInfo(`‚úÖ Connection successful!<br>Timestamp: ${new Date(data.timestamp).toLocaleTimeString()}`);
        alert("‚úÖ Firebase connection test successful!");
        
    } catch (error) {
        console.error("‚ùå Firebase test failed:", error);
        updateFirebaseInfo(`‚ùå Connection failed: ${error.message}`);
        alert("‚ùå Firebase connection test failed!");
    }
}

// ==================== TOKEN VALIDATION FUNCTIONS ====================
async function validateTokenFromFirebase(token) {
    if (!isFirebaseConnected) {
        console.log("üîÑ Firebase offline, using local validation");
        return validateTokenLocally(token);
    }
    
    try {
        console.log(`üîç Validating token ${token} from Firebase...`);
        const snapshot = await database.ref('tokens/' + token).once('value');
        const tokenData = snapshot.val();
        
        if (tokenData && tokenData.status === 'active') {
            const expiryDate = new Date(tokenData.expiry);
            const today = new Date();
            
            if (today <= expiryDate) {
                console.log("‚úÖ Token valid from Firebase:", tokenData);
                return { 
                    valid: true, 
                    data: tokenData 
                };
            } else {
                console.log("‚ùå Token expired in Firebase");
                return { 
                    valid: false, 
                    error: 'Token telah kadaluarsa' 
                };
            }
        } else {
            console.log("‚ùå Token not found in Firebase");
            return { 
                valid: false, 
                error: 'Token tidak ditemukan di server' 
            };
        }
        
    } catch (error) {
        console.error("‚ùå Error validating from Firebase:", error);
        // Fallback to local validation
        return validateTokenLocally(token);
    }
}

function validateTokenLocally(token) {
    console.log(`üîç Validating token ${token} locally...`);
    const adminDB = JSON.parse(localStorage.getItem('kalender_token_database') || '{}');
    const today = new Date();
    
    if (adminDB[token]) {
        const tokenData = adminDB[token];
        const expiryDate = new Date(tokenData.expiry);
        
        if (today <= expiryDate) {
            console.log("‚úÖ Token valid locally:", tokenData);
            return { 
                valid: true, 
                data: tokenData 
            };
        } else {
            console.log("‚ùå Token expired locally");
            return { 
                valid: false, 
                error: 'Token telah kadaluarsa' 
            };
        }
    } else {
        console.log("‚ùå Token not found locally");
        return { 
            valid: false, 
            error: 'Token tidak ditemukan' 
        };
    }
}

async function syncTokenWithFirebase() {
    const token = localStorage.getItem('kalender_token_tius');
    if (!token || !isFirebaseConnected) return;
    
    try {
        const snapshot = await database.ref('tokens/' + token).once('value');
        const tokenData = snapshot.val();
        
        if (tokenData) {
            // Update local storage with latest data from Firebase
            localStorage.setItem('premium_token', JSON.stringify(tokenData));
            
            const adminDB = JSON.parse(localStorage.getItem('kalender_token_database') || '{}');
            adminDB[token] = tokenData;
            localStorage.setItem('kalender_token_database', JSON.stringify(adminDB));
            
            console.log("‚úÖ Token synced from Firebase");
            checkPremiumStatus();
        }
    } catch (error) {
        console.error("‚ùå Error syncing token:", error);
    }
}

// ==================== TOKEN MODAL FUNCTIONS ====================
function showTokenModal() {
    // Check if already premium
    if (checkPremiumStatus()) {
        const token = localStorage.getItem('kalender_token_tius');
        const tokenData = JSON.parse(localStorage.getItem('premium_token') || '{}');
        
        alert(`‚úÖ Anda sudah premium!\n\nüì¶ Paket: ${tokenData.package || 'Premium'}\nüìÖ Berlaku hingga: ${tokenData.expiry || 'Tidak diketahui'}\n\nToken: ${token}`);
        return;
    }
    
    document.getElementById('tokenModal').style.display = 'flex';
    document.getElementById('tokenInput').focus();
}

function closeTokenModal() {
    document.getElementById('tokenModal').style.display = 'none';
}

async function validateToken() {
    const tokenInput = document.getElementById('tokenInput');
    const token = tokenInput.value.trim().toUpperCase();
    
    if (!token) {
        alert('‚ö†Ô∏è Masukkan token terlebih dahulu');
        return;
    }
    
    console.log(`üöÄ Validating token: ${token}`);
    
    // Show loading
    tokenInput.disabled = true;
    document.querySelector('.token-btn').innerHTML = 'üîÑ Memvalidasi...';
    
    try {
        // Validate from Firebase (with local fallback)
        const result = await validateTokenFromFirebase(token);
        
        if (result.valid) {
            // Save token locally
            localStorage.setItem('kalender_token_tius', token);
            localStorage.setItem('premium_token', JSON.stringify(result.data));
            
            // Also save to admin database
            const adminDB = JSON.parse(localStorage.getItem('kalender_token_database') || '{}');
            adminDB[token] = result.data;
            localStorage.setItem('kalender_token_database', JSON.stringify(adminDB));
            
            console.log("‚úÖ Token activated:", result.data);
            
            // Show success message
            alert(`‚úÖ Token berhasil diaktifkan!\n\nüì¶ Paket: ${result.data.package}\nüìÖ Berlaku hingga: ${result.data.expiry}\n‚úâÔ∏è Email: ${result.data.email || '-'}\n\n${isFirebaseConnected ? '‚úÖ Disimpan di server' : '‚ö†Ô∏è Mode offline'}`);
            
            closeTokenModal();
            
            // Refresh page to show premium features
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`‚ùå ${result.error}\n\nüìû Hubungi admin: 0851-1702-1168\nüí¨ WhatsApp: https://wa.me/6285117021168`);
        }
        
    } catch (error) {
        console.error("‚ùå Validation error:", error);
        alert("‚ùå Error memvalidasi token. Coba lagi.");
    } finally {
        // Reset button
        tokenInput.disabled = false;
        document.querySelector('.token-btn').innerHTML = 'Aktifkan Token';
        tokenInput.value = '';
    }
}

// ==================== URL TOKEN FUNCTIONS ====================
async function checkTokenFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (token) {
        console.log(`üîó Found token in URL: ${token}`);
        const result = await validateTokenFromFirebase(token);
        
        if (result.valid) {
            // Save token
            localStorage.setItem('kalender_token_tius', token);
            localStorage.setItem('premium_token', JSON.stringify(result.data));
            
            // Update admin DB
            const adminDB = JSON.parse(localStorage.getItem('kalender_token_database') || '{}');
            adminDB[token] = result.data;
            localStorage.setItem('kalender_token_database', JSON.stringify(adminDB));
            
            // Remove token from URL
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
            
            // Show notification
            showNotification('‚úÖ Token dari URL berhasil diaktifkan!');
            
            // Refresh
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } else {
            alert(`‚ùå Token dari URL tidak valid: ${result.error}`);
        }
    } else {
        alert('‚ö†Ô∏è Tidak ada token di URL');
    }
}

function getTokenFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (token) {
        console.log(`üîç Auto-checking URL token: ${token}`);
        // Auto-validate if token exists
        setTimeout(() => {
            validateTokenFromFirebase(token).then(result => {
                if (result.valid) {
                    // Auto-activate
                    localStorage.setItem('kalender_token_tius', token);
                    localStorage.setItem('premium_token', JSON.stringify(result.data));
                    
                    const adminDB = JSON.parse(localStorage.getItem('kalender_token_database') || '{}');
                    adminDB[token] = result.data;
                    localStorage.setItem('kalender_token_database', JSON.stringify(adminDB));
                    
                    // Clean URL
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    
                    // Show notification
                    showNotification('‚úÖ Token dari link otomatis diaktifkan!');
                    
                    // Reload after a moment
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            });
        }, 1000);
    }
}

// ==================== PREMIUM STATUS ====================
function checkPremiumStatus() {
    const token = localStorage.getItem('kalender_token_tius');
    const today = new Date();
    
    if (token) {
        const savedToken = localStorage.getItem('premium_token');
        if (savedToken) {
            try {
                const tokenData = JSON.parse(savedToken);
                const expiryDate = new Date(tokenData.expiry);
                
                if (today <= expiryDate) {
                    // Update badge
                    const badge = document.getElementById('premiumBadge');
                    if (badge) {
                        badge.style.display = 'inline-block';
                        badge.innerHTML = `<i class="fas fa-crown"></i> ${tokenData.package || 'PREMIUM'}`;
                        badge.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                    }
                    
                    console.log("‚úÖ Premium access active");
                    return true;
                } else {
                    // Token expired
                    console.log("‚ùå Token expired");
                    localStorage.removeItem('kalender_token_tius');
                    localStorage.removeItem('premium_token');
                    
                    const badge = document.getElementById('premiumBadge');
                    if (badge) {
                        badge.innerHTML = `<i class="fas fa-crown"></i> FREE`;
                        badge.style.background = '#ccc';
                    }
                }
            } catch (e) {
                console.error("Error parsing token:", e);
            }
        }
    }
    
    return false;
}

// ==================== NOTIFICATION ====================
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add CSS for animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ==================== SCROLL TO TOP ====================
function initScrollToTop() {
    const scrollBtn = document.getElementById('scrollTopBtn');
    
    if (!scrollBtn) return;
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            scrollBtn.style.display = 'flex';
        } else {
            scrollBtn.style.display = 'none';
        }
    });
    
    scrollBtn.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

// ==================== INITIALIZATION ====================
window.addEventListener('load', function() {
    console.log('üöÄ Kalender Jawa loading...');
    document.getElementById('appStatus').textContent = '‚úÖ Aplikasi siap digunakan';
    
    // Initialize Firebase
    initializeFirebase();
    
    // Check token from URL
    getTokenFromURL();
    
    // Check premium status
    checkPremiumStatus();
    
    // Set today's date in search input
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const searchInput = document.getElementById('dateSearchInput');
    if (searchInput) {
        searchInput.value = todayStr;
        searchInput.max = '2100-12-31';
        searchInput.min = '1900-01-01';
    }
    
    // Initialize scroll to top button
    initScrollToTop();
    
    // PWA Installation
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        setTimeout(() => {
            if (confirm('Ingin pasang Kalender Jawa di perangkat Anda?')) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install');
                    }
                    deferredPrompt = null;
                });
            }
        }, 10000);
    });
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('‚úÖ Service Worker registered'))
            .catch(err => console.log('‚ùå Service Worker registration failed:', err));
    }
});

// Online/Offline detection
window.addEventListener('online', () => {
    document.getElementById('appStatus').textContent = '‚úÖ Online - Aplikasi siap';
    console.log('‚úÖ Back online');
    
    // Re-check Firebase connection
    setTimeout(() => {
        if (database) {
            const connectedRef = database.ref(".info/connected");
            connectedRef.once("value").then(snap => {
                if (snap.val() === true) {
                    updateConnectionStatus();
                    syncTokenWithFirebase();
                }
            });
        }
    }, 1000);
});

window.addEventListener('offline', () => {
    document.getElementById('appStatus').textContent = '‚ö†Ô∏è Offline - Mode terbatas';
    console.log('‚ö†Ô∏è Offline mode');
    updateConnectionStatus();
});
</script>

</body>
</html>
