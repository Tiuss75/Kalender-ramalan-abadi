<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Kalender Jawa</title>
    
    <!-- Firebase SDK -->
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #D30000 0%, #9B0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .admin-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .admin-header p {
            opacity: 0.9;
        }
        
        .admin-content {
            padding: 30px;
            display: grid;
            gap: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .section h2 {
            color: #D30000;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .package-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .package-btn {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .package-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .package-btn.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .package-btn .duration {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .package-btn .price {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        
        .package-btn .discount {
            color: #666;
            font-size: 0.9em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #388E3C;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #1976D2;
        }
        
        .btn-danger {
            background: #F44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #D32F2F;
        }
        
        .token-result {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .token-result.show {
            display: block;
        }
        
        .token-code {
            background: #333;
            color: #4CAF50;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 1.2em;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .token-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .token-info div {
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
        
        .token-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .token-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .token-item.expired {
            opacity: 0.6;
            background: #f5f5f5;
        }
        
        .token-item .token-code {
            background: none;
            color: #333;
            padding: 0;
            font-size: 1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card.total .number { color: #D30000; }
        .stat-card.active .number { color: #4CAF50; }
        .stat-card.expired .number { color: #F44336; }
        
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .firebase-status.online {
            background: #4CAF50;
            color: white;
        }
        
        .firebase-status.offline {
            background: #F44336;
            color: white;
        }
        
        @media (max-width: 768px) {
            .admin-content {
                padding: 20px;
            }
            
            .package-grid {
                grid-template-columns: 1fr;
            }
            
            .firebase-status {
                position: static;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status offline">
        üîå Firebase: Offline
    </div>

    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1>üõ†Ô∏è Admin Panel Kalender Jawa</h1>
            <p>Kelola token akses premium untuk aplikasi Kalender Jawa</p>
            <p id="appVersion" style="font-size: 12px; margin-top: 10px;">Firebase Version</p>
        </div>
        
        <!-- Main Content -->
        <div class="admin-content">
            <!-- Password Section -->
            <div class="section" id="passwordSection">
                <h2>üîê Verifikasi Admin</h2>
                <div class="form-group">
                    <label>Password Admin:</label>
                    <input type="password" id="adminPassword" placeholder="Masukkan password admin">
                </div>
                <button class="btn btn-primary" onclick="verifyAdmin()">
                    üîë Login sebagai Admin
                </button>
            </div>
            
            <!-- Main Panel (hidden until verified) -->
            <div class="section" id="mainPanel" style="display: none;">
                <!-- Firebase Connection Status -->
                <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <span id="connectionStatus">üîÑ Menghubungkan ke Firebase...</span>
                </div>
                
                <!-- Generate Token Section -->
                <div>
                    <h2>üì¶ Generate Token Baru</h2>
                    <p>Pilih paket dan buat token untuk pelanggan:</p>
                    
                    <div class="package-grid" id="packageGrid">
                        <!-- Packages will be loaded here -->
                    </div>
                    
                    <div class="form-group">
                        <label>Email Pelanggan (optional):</label>
                        <input type="email" id="customerEmail" placeholder="email@pelanggan.com">
                    </div>
                    
                    <div class="form-group">
                        <label>Catatan (optional):</label>
                        <textarea id="tokenNote" rows="3" placeholder="Catatan untuk token ini"></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateSelectedToken()">
                        üé´ Generate Token
                    </button>
                    
                    <!-- Token Result -->
                    <div class="token-result" id="tokenResult">
                        <h3>‚úÖ Token Berhasil Dibuat!</h3>
                        <p>Salin token berikut dan berikan kepada pelanggan:</p>
                        <div class="token-code" id="newTokenCode"></div>
                        
                        <div class="token-info">
                            <div>
                                <strong>Paket:</strong><br>
                                <span id="newTokenPackage"></span>
                            </div>
                            <div>
                                <strong>Berlaku hingga:</strong><br>
                                <span id="newTokenExpiry"></span>
                            </div>
                            <div>
                                <strong>Tanggal dibuat:</strong><br>
                                <span id="newTokenCreated"></span>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="copyTokenToClipboard()">
                            üìã Salin Token
                        </button>
                        <button class="btn" onclick="shareTokenViaLink()" style="background: #2196F3; color: white; margin-left: 10px;">
                            üîó Buat Link Share
                        </button>
                        <button class="btn" onclick="printToken()" style="background: #FF9800; color: white; margin-left: 10px;">
                            üñ®Ô∏è Cetak
                        </button>
                    </div>
                </div>
                
                <!-- Token Management -->
                <div>
                    <h2>üìã Kelola Token</h2>
                    
                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card total">
                            <div class="number" id="totalTokens">0</div>
                            <div>Total Token</div>
                        </div>
                        <div class="stat-card active">
                            <div class="number" id="activeTokens">0</div>
                            <div>Token Aktif</div>
                        </div>
                        <div class="stat-card expired">
                            <div class="number" id="expiredTokens">0</div>
                            <div>Token Expired</div>
                        </div>
                    </div>
                    
                    <!-- Token List -->
                    <div class="token-list" id="tokenList">
                        <!-- Tokens will be loaded here -->
                    </div>
                    
                    <button class="btn btn-secondary" onclick="refreshTokenList()">
                        üîÑ Refresh List
                    </button>
                    <button class="btn btn-danger" onclick="clearExpiredTokens()" style="margin-left: 10px;">
                        üóëÔ∏è Hapus Expired
                    </button>
                </div>
                
                <!-- Revoke Token -->
                <div>
                    <h2>üóëÔ∏è Hapus Token</h2>
                    <div class="form-group">
                        <label>Token yang akan dihapus:</label>
                        <input type="text" id="revokeTokenInput" placeholder="Masukkan kode token">
                    </div>
                    <button class="btn btn-danger" onclick="revokeSelectedToken()">
                        ‚ùå Hapus Token
                    </button>
                    <div id="revokeResult" style="margin-top: 15px;"></div>
                </div>
                
                <!-- Export/Import -->
                <div>
                    <h2>üíæ Backup & Restore</h2>
                    <button class="btn btn-secondary" onclick="exportTokens()">
                        üíæ Export Tokens (JSON)
                    </button>
                    <button class="btn" onclick="importTokens()" style="background: #9C27B0; color: white; margin-left: 10px;">
                        üì• Import Tokens
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(this)">
                    
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        Export untuk backup data token. Import untuk restore dari backup.
                    </p>
                </div>
                
                <!-- Firebase Info -->
                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <h3>üìä Firebase Status</h3>
                    <div id="firebaseInfo" style="font-size: 13px; color: #666;">
                        Menunggu koneksi...
                    </div>
                    <button onclick="testFirebaseConnection()" style="margin-top: 10px; padding: 8px 15px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Test Koneksi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        // üî• GANTI DENGAN KONFIGURASI FIREBASE ANDA
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCir9IhWurIN8P2LiCfb445ss-bsurrFG4",
            authDomain: "kalender-ramalan.firebaseapp.com",
            databaseURL: "https://kalender-ramalan-default-rtdb.firebaseio.com",
            projectId: "kalender-ramalan",
            storageBucket: "kalender-ramalan.firebasestorage.app",
            messagingSenderId: "811026418437",
            appId: "1:811026418437:web:b0efdd1eb52fd4688bc56c"
        };

        // ==================== APP CONFIGURATION ====================
        const PACKAGES = {
            "1bulan": {
                name: "1 Bulan",
                duration: 1,
                price: "Rp 25.000",
                discount: "",
                color: "#4CAF50"
            },
            "3bulan": {
                name: "3 Bulan",
                duration: 3,
                price: "Rp 60.000",
                discount: "Hemat 20%",
                color: "#2196F3"
            },
            "6bulan": {
                name: "6 Bulan",
                duration: 6,
                price: "Rp 100.000",
                discount: "Hemat 33%",
                color: "#FF9800"
            },
            "1tahun": {
                name: "1 Tahun",
                duration: 12,
                price: "Rp 150.000",
                discount: "Hemat 50%",
                color: "#9C27B0"
            },
            "unlimited": {
                name: "Unlimited",
                duration: 9999,
                price: "Rp 500.000",
                discount: "Akses seumur hidup",
                color: "#D30000"
            }
        };

        const ADMIN_PASSWORD = "admin123"; // üîê Ganti password ini
        const APP_URL = "https://www.kalenderjawaabadi.my.id/"; // üåê Ganti dengan URL GitHub Pages Anda

        // ==================== GLOBAL VARIABLES ====================
        let tokenDatabase = JSON.parse(localStorage.getItem('kalender_token_database') || '{}');
        let selectedPackage = null;
        let firebaseApp = null;
        let database = null;
        let isFirebaseConnected = false;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Admin Panel Loading...");
            renderPackageGrid();
            initializeFirebase();
            loadTokenDatabase();
            checkAdminSession();
        });

        // ==================== FIREBASE FUNCTIONS ====================
        function initializeFirebase() {
            try {
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                database = firebase.database();
                
                // Set up connection state listener
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    isFirebaseConnected = snap.val() === true;
                    updateConnectionStatus();
                });
                
                console.log("‚úÖ Firebase initialized successfully");
                updateFirebaseInfo("Firebase terhubung");
                
            } catch (error) {
                console.error("‚ùå Firebase initialization error:", error);
                updateFirebaseInfo(`Error: ${error.message}`);
            }
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const badgeElement = document.getElementById('firebaseStatus');
            
            if (isFirebaseConnected) {
                if (statusElement) statusElement.innerHTML = "‚úÖ Terhubung ke Firebase";
                if (badgeElement) {
                    badgeElement.className = "firebase-status online";
                    badgeElement.innerHTML = "‚úÖ Firebase: Online";
                }
            } else {
                if (statusElement) statusElement.innerHTML = "üîå Tidak terhubung ke Firebase (Mode Offline)";
                if (badgeElement) {
                    badgeElement.className = "firebase-status offline";
                    badgeElement.innerHTML = "üîå Firebase: Offline";
                }
            }
        }

        function updateFirebaseInfo(message) {
            const infoElement = document.getElementById('firebaseInfo');
            if (infoElement) {
                infoElement.innerHTML = message;
            }
        }

        async function testFirebaseConnection() {
            try {
                updateFirebaseInfo("üîÑ Testing connection...");
                
                // Test write
                const testRef = database.ref('testConnection');
                await testRef.set({
                    timestamp: Date.now(),
                    test: "connection_test"
                });
                
                // Test read
                const snapshot = await testRef.once('value');
                const data = snapshot.val();
                
                // Clean up
                await testRef.remove();
                
                updateFirebaseInfo(`‚úÖ Connection successful!<br>Timestamp: ${new Date(data.timestamp).toLocaleTimeString()}`);
                alert("‚úÖ Firebase connection test successful!");
                
            } catch (error) {
                console.error("‚ùå Firebase test failed:", error);
                updateFirebaseInfo(`‚ùå Connection failed: ${error.message}`);
                alert("‚ùå Firebase connection test failed!");
            }
        }

        // ==================== TOKEN FUNCTIONS (FIREBASE) ====================
        async function saveTokenToFirebase(token, tokenData) {
            if (!isFirebaseConnected) {
                console.log("üîÑ Firebase offline, saving locally only");
                throw new Error("Firebase offline");
            }
            
            try {
                console.log(`üì§ Saving token ${token} to Firebase...`);
                await database.ref('tokens/' + token).set(tokenData);
                console.log(`‚úÖ Token ${token} saved to Firebase`);
                return true;
            } catch (error) {
                console.error(`‚ùå Error saving token to Firebase:`, error);
                throw error;
            }
        }

        async function deleteTokenFromFirebase(token) {
            if (!isFirebaseConnected) {
                console.log("üîÑ Firebase offline, deleting locally only");
                return false;
            }
            
            try {
                await database.ref('tokens/' + token).remove();
                console.log(`‚úÖ Token ${token} deleted from Firebase`);
                return true;
            } catch (error) {
                console.error(`‚ùå Error deleting token from Firebase:`, error);
                return false;
            }
        }

        async function syncWithFirebase() {
            if (!isFirebaseConnected) {
                console.log("üîÑ Firebase offline, skipping sync");
                return;
            }
            
            try {
                console.log("üîÑ Syncing with Firebase...");
                const snapshot = await database.ref('tokens').once('value');
                const firebaseTokens = snapshot.val() || {};
                
                // Merge Firebase data with local
                Object.assign(tokenDatabase, firebaseTokens);
                localStorage.setItem('kalender_token_database', JSON.stringify(tokenDatabase));
                
                console.log(`‚úÖ Sync complete: ${Object.keys(firebaseTokens).length} tokens from Firebase`);
                updateFirebaseInfo(`‚úÖ Sync complete: ${Object.keys(firebaseTokens).length} tokens`);
                
            } catch (error) {
                console.error("‚ùå Sync failed:", error);
                updateFirebaseInfo(`‚ùå Sync failed: ${error.message}`);
            }
        }

        // ==================== MAIN FUNCTIONS ====================
        function renderPackageGrid() {
            const grid = document.getElementById('packageGrid');
            grid.innerHTML = '';
            
            for (const [key, pkg] of Object.entries(PACKAGES)) {
                const div = document.createElement('div');
                div.className = 'package-btn';
                div.dataset.package = key;
                div.onclick = () => selectPackage(key);
                
                div.innerHTML = `
                    <div class="duration">${pkg.name}</div>
                    <div class="price">${pkg.price}</div>
                    ${pkg.discount ? `<div class="discount">${pkg.discount}</div>` : ''}
                `;
                
                grid.appendChild(div);
            }
        }

        function selectPackage(packageKey) {
            document.querySelectorAll('.package-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedBtn = document.querySelector(`[data-package="${packageKey}"]`);
            selectedBtn.classList.add('selected');
            selectedPackage = packageKey;
        }

        function checkAdminSession() {
            const isVerified = localStorage.getItem('admin_verified') === 'true';
            if (isVerified) {
                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('mainPanel').style.display = 'block';
                updateStats();
                loadTokenList();
            }
        }

        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('admin_verified', 'true');
                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('mainPanel').style.display = 'block';
                updateStats();
                loadTokenList();
                
                // Sync dengan Firebase setelah login
                setTimeout(() => {
                    syncWithFirebase();
                }, 1000);
                
            } else {
                alert('‚ùå Password salah!');
            }
        }

        async function generateSelectedToken() {
            if (!selectedPackage) {
                alert('Pilih paket terlebih dahulu!');
                return;
            }
            
            const packageData = PACKAGES[selectedPackage];
            const customerEmail = document.getElementById('customerEmail').value;
            const note = document.getElementById('tokenNote').value;
            
            // Generate token code
            const prefix = selectedPackage === 'unlimited' ? 'VIP' : 'TKN';
            const randomNum = Math.floor(100000 + Math.random() * 900000);
            const year = new Date().getFullYear().toString().substr(-2);
            const token = `${prefix}${randomNum}${year}`;
            
            // Calculate expiry date
            const today = new Date();
            const expiryDate = new Date(today);
            
            if (selectedPackage === 'unlimited') {
                expiryDate.setFullYear(9999);
            } else {
                expiryDate.setMonth(today.getMonth() + packageData.duration);
            }
            
            // Format dates
            const createdStr = today.toISOString().split('T')[0];
            const expiryStr = expiryDate.toISOString().split('T')[0];
            
            // Token data
            const tokenData = {
                token: token,
                package: packageData.name,
                created: createdStr,
                expiry: expiryStr,
                email: customerEmail || '',
                note: note || '',
                status: 'active',
                generatedBy: 'admin_panel'
            };
            
            try {
                // Try to save to Firebase first
                if (isFirebaseConnected) {
                    await saveTokenToFirebase(token, tokenData);
                }
                
                // Always save locally
                tokenDatabase[token] = tokenData;
                localStorage.setItem('kalender_token_database', JSON.stringify(tokenDatabase));
                
                // Show result
                document.getElementById('newTokenCode').textContent = token;
                document.getElementById('newTokenPackage').textContent = packageData.name;
                document.getElementById('newTokenExpiry').textContent = expiryStr;
                document.getElementById('newTokenCreated').textContent = createdStr;
                document.getElementById('tokenResult').classList.add('show');
                
                // Update UI
                updateStats();
                loadTokenList();
                
                // Scroll to result
                document.getElementById('tokenResult').scrollIntoView({ behavior: 'smooth' });
                
                // Reset form
                document.getElementById('customerEmail').value = '';
                document.getElementById('tokenNote').value = '';
                
                // Show success message
                const message = isFirebaseConnected 
                    ? `‚úÖ Token ${token} berhasil dibuat dan disimpan di server!` 
                    : `‚ö†Ô∏è Token ${token} dibuat (mode offline).`;
                alert(message);
                
            } catch (error) {
                // Fallback: save locally only
                tokenDatabase[token] = tokenData;
                localStorage.setItem('kalender_token_database', JSON.stringify(tokenDatabase));
                
                // Show result anyway
                document.getElementById('newTokenCode').textContent = token;
                document.getElementById('newTokenPackage').textContent = packageData.name;
                document.getElementById('newTokenExpiry').textContent = expiryStr;
                document.getElementById('newTokenCreated').textContent = createdStr;
                document.getElementById('tokenResult').classList.add('show');
                
                updateStats();
                loadTokenList();
                
                alert(`‚ö†Ô∏è Token ${token} dibuat (mode offline karena koneksi gagal).`);
            }
        }

        function copyTokenToClipboard() {
            const tokenCode = document.getElementById('newTokenCode').textContent;
            navigator.clipboard.writeText(tokenCode).then(() => {
                alert(`‚úÖ Token ${tokenCode} berhasil disalin!`);
            });
        }

        function shareTokenViaLink() {
            const tokenCode = document.getElementById('newTokenCode').textContent;
            const shareUrl = `${APP_URL}?token=${tokenCode}`;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert(`‚úÖ Link berhasil disalin:\n\n${shareUrl}\n\nKirim link ini ke client.`);
            });
        }

        function printToken() {
            const tokenCode = document.getElementById('newTokenCode').textContent;
            const packageName = document.getElementById('newTokenPackage').textContent;
            const expiry = document.getElementById('newTokenExpiry').textContent;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Token Kalender Jawa</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        .token { font-size: 24px; font-weight: bold; margin: 20px 0; padding: 10px; background: #f0f0f0; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h2>Token Kalender Jawa</h2>
                    <div class="token">${tokenCode}</div>
                    <p><strong>Paket:</strong> ${packageName}</p>
                    <p><strong>Berlaku hingga:</strong> ${expiry}</p>
                    <p><strong>Cara penggunaan:</strong> Masukkan token di aplikasi Kalender Jawa</p>
                    <br>
                    <button onclick="window.print()">üñ®Ô∏è Cetak</button>
                    <button onclick="window.close()">‚úï Tutup</button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function loadTokenDatabase() {
            const saved = localStorage.getItem('kalender_token_database');
            if (saved) {
                tokenDatabase = JSON.parse(saved);
            }
        }

        function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let total = 0;
            let active = 0;
            let expired = 0;
            
            for (const [token, data] of Object.entries(tokenDatabase)) {
                total++;
                const expiryDate = new Date(data.expiry);
                if (today <= expiryDate) {
                    active++;
                } else {
                    expired++;
                }
            }
            
            document.getElementById('totalTokens').textContent = total;
            document.getElementById('activeTokens').textContent = active;
            document.getElementById('expiredTokens').textContent = expired;
        }

        async function loadTokenList() {
            const container = document.getElementById('tokenList');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Sync dengan Firebase terlebih dahulu
            if (isFirebaseConnected) {
                await syncWithFirebase();
            }
            
            if (Object.keys(tokenDatabase).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Belum ada token</p>';
                return;
            }
            
            // Sort by expiry date (newest first)
            const sortedTokens = Object.entries(tokenDatabase)
                .sort(([,a], [,b]) => new Date(b.created) - new Date(a.created));
            
            let html = '';
            
            sortedTokens.forEach(([token, data]) => {
                const expiryDate = new Date(data.expiry);
                const isExpired = today > expiryDate;
                const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                const source = data.generatedBy ? `(${data.generatedBy})` : '';
                
                html += `
                    <div class="token-item ${isExpired ? 'expired' : ''}">
                        <div>
                            <div class="token-code">${token} ${source}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${data.package} ‚Ä¢ Dibuat: ${data.created}
                                ${data.email ? `‚Ä¢ Email: ${data.email}` : ''}
                            </div>
                            ${data.note ? `<div style="font-size: 0.85em; color: #888; margin-top: 5px;">${data.note}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: ${isExpired ? '#F44336' : '#4CAF50'}">
                                ${isExpired ? 'EXPIRED' : `Berlaku hingga: ${data.expiry}`}
                            </div>
                            ${!isExpired ? `<div style="font-size: 0.9em; color: #666;">${daysLeft} hari lagi</div>` : ''}
                            <button onclick="shareToken('${token}')" style="margin-top:5px; padding:5px 10px; background:#2196F3; color:white; border:none; border-radius:5px; font-size:12px;">
                                üîó Share
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function shareToken(token) {
            const shareUrl = `${APP_URL}?token=${token}`;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert(`‚úÖ Link berhasil disalin:\n\n${shareUrl}\n\nKirim link ini ke client.`);
            });
        }

        function refreshTokenList() {
            loadTokenDatabase();
            loadTokenList();
        }

        async function revokeSelectedToken() {
            const token = document.getElementById('revokeTokenInput').value.trim();
            
            if (!token) {
                alert('Masukkan token yang akan dihapus!');
                return;
            }
            
            if (!tokenDatabase[token]) {
                document.getElementById('revokeResult').innerHTML = `
                    <div style="color: #F44336; background: #ffebee; padding: 10px; border-radius: 5px;">
                        ‚ùå Token tidak ditemukan
                    </div>
                `;
                return;
            }
            
            if (confirm(`Hapus token ${token}?\nPaket: ${tokenDatabase[token].package}`)) {
                try {
                    // Delete from Firebase
                    await deleteTokenFromFirebase(token);
                    
                    // Delete from local
                    delete tokenDatabase[token];
                    localStorage.setItem('kalender_token_database', JSON.stringify(tokenDatabase));
                    
                    document.getElementById('revokeResult').innerHTML = `
                        <div style="color: #4CAF50; background: #e8f5e9; padding: 10px; border-radius: 5px;">
                            ‚úÖ Token berhasil dihapus
                        </div>
                    `;
                    
                    document.getElementById('revokeTokenInput').value = '';
                    updateStats();
                    loadTokenList();
                    
                    setTimeout(() => {
                        document.getElementById('revokeResult').innerHTML = '';
                    }, 3000);
                    
                } catch (error) {
                    alert('Gagal menghapus token. Coba lagi.');
                }
            }
        }

        async function clearExpiredTokens() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let expiredCount = 0;
            let tokensToDelete = [];
            
            for (const [token, data] of Object.entries(tokenDatabase)) {
                const expiryDate = new Date(data.expiry);
                if (today > expiryDate) {
                    tokensToDelete.push(token);
                    expiredCount++;
                }
            }
            
            if (expiredCount > 0) {
                if (confirm(`Hapus ${expiredCount} token expired?`)) {
                    // Delete from Firebase
                    for (const token of tokensToDelete) {
                        await deleteTokenFromFirebase(token);
                    }
                    
                    // Delete from local
                    for (const token of tokensToDelete) {
                        delete tokenDatabase[token];
                    }
                    
                    localStorage.setItem('kalender_token_database', JSON.stringify(tokenDatabase));
                    alert(`‚úÖ ${expiredCount} token expired berhasil dihapus`);
                    updateStats();
                    loadTokenList();
                }
            } else {
                alert('Tidak ada token expired');
            }
        }

        function exportTokens() {
            const dataStr = JSON.stringify(tokenDatabase, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tokens_kalender_jawa_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importTokens() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Import to local
                    Object.assign(tokenDatabase, importedData);
                    localStorage.setItem('kalender_token_database', JSON.stringify(tokenDatabase));
                    
                    // Import to Firebase
                    if (isFirebaseConnected) {
                        for (const [token, data] of Object.entries(importedData)) {
                            await saveTokenToFirebase(token, data);
                        }
                    }
                    
                    alert(`‚úÖ ${Object.keys(importedData).length} token berhasil diimport!`);
                    updateStats();
                    loadTokenList();
                } catch (error) {
                    alert('‚ùå File JSON tidak valid!');
                }
            };
            reader.readAsText(file);
            
            input.value = '';
        }
    </script>
</body>
</html>
